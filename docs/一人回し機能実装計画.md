# 一人回し機能 実装計画

## 概要
ポケモンカードゲームの一人回し（ソロプレイ）機能を実装します。対戦相手なしで、デッキを回す練習ができる機能です。

## 機能要件

### Phase 1: 基本ゲーム状態管理（最小限の実装）
**目標**: カードを出して、基本的なゲームフローを体験できる

1. **ゲーム状態の管理**
   - 山札、手札、バトル場、ベンチ、トラッシュ、サイドの管理
   - ターン数の管理
   - エネルギーの管理

2. **基本的な操作**
   - 手札からカードを出す（ポケモン、エネルギー、トレーナーズ）
   - ポケモンをベンチに出す
   - エネルギーをポケモンにつける
   - トレーナーズを使う
   - ターンエンド

3. **UI要件**
   - ゲームボードの表示
   - 手札エリア（ドラッグ&ドロップまたはクリックで操作）
   - バトル場エリア
   - ベンチエリア（最大5枚）
   - トラッシュエリア
   - サイドエリア（6枚）
   - 山札エリア（残り枚数表示）
   - 操作ボタン（ターンエンド、リセット）

### Phase 2: ワザの使用（中級実装）
**目標**: ワザを使ってダメージ計算ができる

1. **ワザ情報の取得**
   - カード詳細ページからワザ情報を取得するAPI
   - ワザ名、ダメージ、必要なエネルギー、効果の取得

2. **ワザの使用**
   - エネルギーコストのチェック
   - ワザの選択と実行
   - ダメージ計算（簡易版：弱点・抵抗力は考慮しない）

3. **UI要件**
   - バトルポケモンのワザ表示
   - ワザ使用ボタン
   - ダメージ表示

### Phase 3: ルールの実装（上級実装）
**目標**: より正確なルールに基づいたゲームプレイ

1. **ルール実装**
   - 【たね】ポケモンの判定
   - 進化のルール
   - 弱点・抵抗力の計算
   - 特殊状態（【どく】【やけど】【ねむり】【マヒ】【こんらん】）
   - ポケモンチェック
   - 【きぜつ】の処理

2. **AI対戦相手（オプション）**
   - 簡単なAI対戦相手の実装

## 技術的な課題と解決策

### 課題1: カード詳細情報の取得
**問題**: 現在はカードの基本情報（名前、画像、カテゴリ）のみ取得できている。ワザ、HP、弱点・抵抗力などの詳細情報が必要。

**解決策**:
- カード詳細ページから情報を取得するAPIエンドポイントを追加
- 取得した情報をキャッシュして再利用
- デッキ解析時に必要なカードの詳細情報を一括取得（オプション）

**実装方針**:
```javascript
// サーバー側: /api/card/:cardId エンドポイントを追加
// クライアント側: 必要なカードの詳細情報を取得してゲーム状態に保存
```

### 課題2: ゲーム状態の複雑性
**問題**: ゲーム状態が複雑で、状態管理が難しい。

**解決策**:
- 状態管理を明確に分離
- イミュータブルな状態更新
- 状態のシリアライズ/デシリアライズ（セーブ/ロード機能）

**データ構造案**:
```javascript
const gameState = {
  turn: 1,
  phase: 'draw', // draw, main, attack, end
  deck: Array<Card>,
  hand: Array<Card>,
  battlePokemon: Card | null,
  bench: Array<Card>,
  trash: Array<Card>,
  prize: Array<Card>,
  attachedEnergy: Map<cardId, Array<Energy>>,
  // 将来的に追加
  // opponent: { ... }
}
```

### 課題3: UIの複雑性
**問題**: ゲームボードのUIが複雑で、操作性が重要。

**解決策**:
- 段階的なUI実装
- ドラッグ&ドロップライブラリの使用（react-dnd, interact.jsなど）
- モバイル対応（タッチ操作）

### 課題4: パフォーマンス
**問題**: カード詳細情報の取得に時間がかかる可能性がある。

**解決策**:
- 必要なカードのみ取得（ポケモンカードのみ）
- バックグラウンドで取得
- プログレスバーで進捗表示

## 実装ステップ

### Step 1: 基本ゲーム状態管理（Phase 1の一部）
1. ゲーム状態のデータ構造を定義
2. カードを手札から出す機能
3. ポケモンをベンチに出す機能
4. エネルギーをつける機能
5. 基本的なUI（ゲームボード）

**推定工数**: 2-3日

### Step 2: カード詳細情報取得API
1. `/api/card/:cardId` エンドポイントの実装
2. カード詳細ページからの情報抽出
3. エラーハンドリングとキャッシュ

**推定工数**: 1-2日

### Step 3: ワザの使用（Phase 2）
1. ワザ情報の表示
2. エネルギーコストのチェック
3. ワザの実行
4. ダメージ計算（簡易版）

**推定工数**: 2-3日

### Step 4: ルールの実装（Phase 3の一部）
1. 【たね】ポケモンの判定
2. 進化のルール
3. 弱点・抵抗力の計算
4. 特殊状態の実装

**推定工数**: 3-5日

## ファイル構成

### 新規作成ファイル
- `public/solo-play.js` - 一人回し機能のメインロジック
- `public/solo-play.css` - 一人回し機能のスタイル
- `public/game-state.js` - ゲーム状態管理モジュール
- `public/card-details.js` - カード詳細情報管理モジュール

### 修正ファイル
- `server.js` - カード詳細情報取得APIの追加
- `public/index.html` - 一人回しセクションの追加
- `public/app.js` - 一人回し機能への遷移

## UIデザイン案

### ゲームボードレイアウト
```
┌─────────────────────────────────────────────┐
│  ターン: 1  [ターンエンド] [リセット]      │
├─────────────────────────────────────────────┤
│  サイド: [6枚]                              │
├─────────────────────────────────────────────┤
│  バトル場: [選択したポケモン]              │
│            [ついているエネルギー]           │
│            [ワザボタン]                     │
├─────────────────────────────────────────────┤
│  ベンチ: [ポケモン1] [ポケモン2] ...       │
│          （最大5枚）                         │
├─────────────────────────────────────────────┤
│  手札: [カード1] [カード2] ... [カード7]   │
│        （クリック/ドラッグで操作）           │
├─────────────────────────────────────────────┤
│  トラッシュ: [カード一覧]                   │
│  山札: XX枚                                 │
└─────────────────────────────────────────────┘
```

## 段階的な実装提案

### 最小実装（MVP）
**目標**: カードを出して、基本的な操作ができる

1. ゲーム状態の管理
2. 手札からカードを出す
3. ポケモンをベンチに出す
4. エネルギーをつける
5. 基本的なUI

**実装期間**: 3-5日

### 推奨実装
**目標**: ワザを使ってダメージ計算ができる

1. 最小実装のすべて
2. カード詳細情報取得API
3. ワザの表示と使用
4. 簡易ダメージ計算

**実装期間**: 1-2週間

### 完全実装
**目標**: ルールに基づいた正確なゲームプレイ

1. 推奨実装のすべて
2. ルールの実装
3. 特殊状態の実装
4. 【きぜつ】の処理

**実装期間**: 2-4週間

## 注意事項

1. **パフォーマンス**: カード詳細情報の取得は時間がかかるため、必要なカードのみ取得する
2. **ユーザビリティ**: 操作が直感的で分かりやすいUIを心がける
3. **モバイル対応**: タッチ操作にも対応する
4. **エラーハンドリング**: カード情報の取得失敗時の処理を適切に実装する

## 今後の拡張案

1. **AI対戦相手**: 簡単なAI対戦相手の実装
2. **セーブ/ロード**: ゲーム状態の保存と読み込み
3. **リプレイ機能**: ゲームの記録と再生
4. **統計機能**: デッキの回りやすさなどの統計
5. **マルチプレイヤー**: オンライン対戦機能
