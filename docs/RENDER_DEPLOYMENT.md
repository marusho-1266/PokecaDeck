# Render デプロイメントガイド

このガイドでは、ポケカデッキ解析ツールをRenderにデプロイする手順を詳しく説明します。

## 前提条件

- GitHubアカウント
- プロジェクトがGitHubリポジトリにプッシュされていること
- Renderアカウント（無料で作成可能）

## ステップ1: Renderアカウントの作成

1. [Render](https://render.com)にアクセス
2. 「Get Started for Free」をクリック
3. GitHubアカウントでログイン（推奨）
   - または、メールアドレスでサインアップ
4. メール認証を完了（メールアドレスでサインアップした場合）

## ステップ2: 新しいWebサービスを作成

1. Renderダッシュボードで「New +」ボタンをクリック
2. 「Web Service」を選択

## ステップ3: GitHubリポジトリを接続

1. 「Connect account」または「Connect GitHub」をクリック
2. GitHubの認証画面で、リポジトリへのアクセス権限を付与
3. デプロイしたいリポジトリを選択
   - リポジトリが見つからない場合は、「Configure GitHub App」で権限を確認

## ステップ4: サービスの設定

以下の設定を行います：

### 基本設定

- **Name**: サービス名を入力（例: `pokeca-deck-analyzer`）
  - この名前がURLの一部になります（例: `pokeca-deck-analyzer.onrender.com`）

- **Region**: 最寄りのリージョンを選択
  - **推奨**: `Singapore`（日本から最も近い）
  - その他の選択肢: `Oregon (US West)`, `Frankfurt (EU)`

- **Branch**: デプロイするブランチを選択（通常は `main` または `master`）

- **Root Directory**: `.`（プロジェクトルート）
  - 変更不要（デフォルトのまま）

### ビルド・起動設定

- **Environment**: `Node` を選択

- **Build Command**: 
  ```
  npm install
  ```
  - 依存関係をインストールします
  - `postinstall`スクリプトにより、Chromeもインストールされます

- **Start Command**: 
  ```
  npm start
  ```
  - `package.json`の`start`スクリプトを実行します
  - `start.sh`スクリプトが起動時にChromeのインストールを確認します
  - Renderではビルドとランタイムが分離されているため、起動時にChromeを再インストールします

### プラン選択

- **Free**: 無料プラン（15分間の非アクティブ後にスリープ）
- **Starter ($7/月)**: スリープしない、より多くのリソース

**初回はFreeプランで試すことを推奨**

## ステップ5: 環境変数の設定（オプション）

現在のプロジェクトでは必須の環境変数はありませんが、必要に応じて設定できます：

1. 「Environment Variables」セクションを開く
2. 「Add Environment Variable」をクリック
3. キーと値を入力

**注意**: `PORT`環境変数はRenderが自動的に設定するため、手動で設定する必要はありません。

## ステップ6: デプロイの開始

1. すべての設定を確認
2. 「Create Web Service」ボタンをクリック
3. デプロイが開始されます

### デプロイの進行状況

- ビルドログが表示されます
- 初回デプロイは5-10分程度かかります
- 以下のようなログが表示されます：
  ```
  ==> Cloning from https://github.com/...
  ==> Installing dependencies
  ==> Building
  ==> Starting service with 'npm start'
  ```

## ステップ7: デプロイの確認

1. デプロイが完了すると、「Your service is live」と表示されます
2. 生成されたURLをクリックしてアクセス
   - 例: `https://pokeca-deck-analyzer.onrender.com`
3. アプリケーションが正常に動作するか確認

### 動作確認

1. ブラウザでアプリケーションにアクセス
2. デッキコードを入力して解析を実行
3. エラーが発生しないか確認

## トラブルシューティング

### よくある問題と解決方法

#### 1. ビルドエラー

**症状**: デプロイが失敗する

**原因と対処法**:
- `package.json`の依存関係に問題がある可能性
- Renderのログを確認してエラーメッセージを確認
- ローカルで`npm install`が成功するか確認

#### 2. アプリケーションが起動しない

**症状**: デプロイは成功したが、アプリケーションにアクセスできない

**原因と対処法**:
- `Start Command`が正しいか確認（`npm start`）
- `server.js`が`process.env.PORT`を使用しているか確認（既に実装済み）
- ログを確認してエラーメッセージを確認

#### 3. Puppeteerが動作しない / Chromeが見つからないエラー

**症状**: デッキ解析が失敗する、または「Could not find Chrome」エラーが発生する

**原因と対処法**:
- Renderでは、ビルド環境とランタイム環境が分離されているため、ビルド時にインストールしたChromeがランタイムに存在しない可能性があります
- この問題を解決するため、以下の対策が実装されています：
  1. `package.json`の`postinstall`スクリプトでビルド時にChromeをインストール
  2. `start.sh`スクリプトで起動時にChromeを再インストール（ランタイム環境用）
  3. `server.js`でChromeが見つからない場合のフォールバック処理
- 既に修正済みの場合は、再デプロイしてください
- `server.js`のPuppeteer設定を確認（`--no-sandbox`オプションが含まれているか）
- メモリ不足の可能性がある場合は、Starterプランにアップグレード
- 起動時にChromeのインストールが行われるため、初回リクエストまでに少し時間がかかる場合があります

#### 4. スリープからの復帰が遅い（無料プラン）

**症状**: 15分間アクセスがないと、次回アクセス時に30秒〜1分かかる

**原因**: 無料プランは15分間の非アクティブ後にスリープします

**対処法**:
- Starterプラン（$7/月）にアップグレードするとスリープしません
- または、外部サービス（UptimeRobotなど）で定期的にpingを送る

#### 5. タイムアウトエラー

**症状**: デッキ解析がタイムアウトする

**原因と対処法**:
- 外部サイトへのアクセスが遅い可能性
- `server.js`のタイムアウト設定を確認（現在30秒）
- Starterプランにアップグレードしてリソースを増やす

## ログの確認方法

1. Renderダッシュボードでサービスを選択
2. 「Logs」タブをクリック
3. リアルタイムログを確認
4. エラーが発生した場合は、ログから原因を特定

## デプロイの更新

GitHubにpushするだけで自動的に再デプロイされます：

1. コードを変更
2. GitHubにpush
3. Renderが自動的に検知して再デプロイを開始
4. 数分後に新しいバージョンがデプロイされます

**手動で再デプロイする場合**:
1. Renderダッシュボードでサービスを選択
2. 「Manual Deploy」→「Deploy latest commit」をクリック

## カスタムドメインの設定（オプション）

1. Renderダッシュボードでサービスを選択
2. 「Settings」タブを開く
3. 「Custom Domains」セクションでドメインを追加
4. DNS設定を更新（Renderの指示に従う）

## プランのアップグレード

無料プランからStarterプランにアップグレードする場合：

1. Renderダッシュボードでサービスを選択
2. 「Settings」タブを開く
3. 「Plan」セクションで「Starter」を選択
4. 支払い情報を入力
5. アップグレードが完了すると、スリープしなくなります

## セキュリティのベストプラクティス

1. **環境変数**: 機密情報は環境変数として設定
2. **HTTPS**: Renderは自動的にHTTPSを提供
3. **CORS**: 必要に応じてCORS設定を調整（現在は`*`で全許可）

## パフォーマンスの最適化

1. **ブラウザインスタンスの再利用**: `server.js`で既に実装済み
2. **メモリ管理**: ページを適切にクローズ（既に実装済み）
3. **タイムアウト設定**: 適切なタイムアウト値を設定（既に実装済み）

## 次のステップ

デプロイが完了したら：

1. アプリケーションをテスト
2. エラーがないか確認
3. 必要に応じてStarterプランにアップグレード
4. カスタムドメインを設定（オプション）

## 参考リンク

- [Render公式ドキュメント](https://render.com/docs)
- [Renderサポート](https://render.com/docs/support)
- [Renderコミュニティ](https://community.render.com/)

## サポート

問題が発生した場合：

1. Renderのログを確認
2. このガイドのトラブルシューティングセクションを参照
3. [Renderコミュニティ](https://community.render.com/)で質問
4. [Renderサポート](https://render.com/docs/support)に連絡
